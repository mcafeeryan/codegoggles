<html>
	<head>
		<link rel="stylesheet" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" type="text/css">
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
		<script type="text/javascript">

            var magic_constant = 600
			var container, svg, tree;
	
            function depth(data) {
                var d = 0
                if (data.type === "select") {
                    return depth(data.from) +1
                }
                if (data.type === "join") {
                    for (var i = 0; i < data.items.length; i++) {
                        if (depth(data.items[i]) > d) {
                            d = depth(data.items[i])
                        }
                    }
                }
                return d+1
            }
 
            function calc_children(node) {
                if (node._children) return node._children;
                switch (node.type.toLowerCase()) {
                case "select":
                    return [{"type": "symbol", "symbol": "&sigma;", "_children": [node.from]}];
                case "join":
                case "inner join":
                    return [{"type": "symbol", "symbol": "&#x2A1D;", "_children": node.items}];
                }
            }

			function getCols(d) {
				if (d._cols) return d._cols;
				
				switch (d.type.toLowerCase()) {
				case "join":
                case "inner join":
					var joinItems = d.on.split("=");
					for (var i = 0; i < joinItems.length; i++) {
						joinItems[i] = joinItems[i].trim();
					}
					var cols = [].concat(getCols(d.items[0]));
					cols.splice(cols.indexOf(joinItems[0]), 1);
					var mid = cols.length;
					cols = cols.concat(getCols(d.items[1]))
					cols.splice(cols.indexOf(joinItems[1]), 1);
					cols.splice(mid, 0, joinItems[0]+","+joinItems[1]);
					cols = cols;
					d._cols = cols;
					break;
				case "select":
					var cols = [];
					for (var i = 0; i < d.items.length; i++) {
						cols.push(d.items[i].name);
					}
					d._cols = cols; break;
				case "table":
                    if (!d.columns) {
                        c = getCols(d.parent.parent)
                        s = d.parent._children.indexOf(d)
                        console.log(s)
                        console.log(c)
                        if (s) {
                            f = [c[0]]
                            c = c.slice(2)
                            c = f.concat(c)
                        }
                        else {
                            c = c.slice(0, 2)
                        }
                        console.log(c)
                        d.columns = c

                    }
					d._cols = d.columns; break;
				}
				return d._cols || [];
			}

			function drawStuff(data) {
                console.log(data)
				$("#container").width(depth(data)*magic_constant)
                $("#container").empty()
				container = d3.select("#container");
				
				var width = $(container[0]).width()*0.7;
				var height = $(container[0]).height();

				svg = container.append("svg:svg")
				.attr("width", width)
				.attr("height", height);
			
				tree = d3.layout.tree()
				.size([height, width])

				.children(calc_children)
                   
				var nodes = tree.nodes(data);
				var links = tree.links(nodes);
				
				container.selectAll("div.node").data(tree.nodes(data))
				.enter().append("div").attr("class", "node")
				.style("left", function(d) { return tree.size()[1]-d.y; })
				.style("top", function(d) { return d.x; })
				.html(function(d) {
					var rows = [];
					switch (d.type.toLowerCase()) {
					case "symbol":
						return "<span class='symbol'>"+d.symbol+"</span>";
                    case "join":
					case "inner join":
						rows.push("<tr><th class='transient'>" + d.type.toUpperCase() + "</th></tr>"); break;
					case "select":
						rows.push("<tr><th class='transient'>" + d.type.toUpperCase() + "</th></tr>"); break;
					case "table":
						rows.push("<tr><th><span class='identifier'>"+d.name+"</span></th></tr>");

					}
					$.each(getCols(d), function(i, e) {
						rows.push("<tr><td>"+e+"</td></tr>");
					});

					if (d.type.toLowerCase() === "select") {
	                    if (d.where) {
      						rows.push("<tr><th class='extra'>"+"WHERE"+"</th></tr>");
      						rows.push("<tr><td>"+d.where+"</td></tr>");
	                    }
	                }
	                if (d.type.toLowerCase() === "join" || d.type.toLowerCase() === "inner join") {
	                	rows.push("<tr><th class='extra'>"+"ON"+"</th></tr>");
	                	rows.push("<tr><td class='ignore'>"+d.on+"</td></tr>");
	                }

					return "<table>"+rows.join("")+"</table>";
				})
				
				svg.selectAll("path")
				.data(links)
				.enter().append("svg:path")
				.attr("class", "link")
				.attr("d", d3.svg.diagonal().projection(function(d) { return [tree.size()[1]-d.y, d.x]; }))
				.attr("fill", "none")
				.attr("stroke", "#ccc");

				  $('td[class!=ignore]').hover(function(){
				  $(this).parent().addClass('highlight_tr');

				  var text = $(this).parent().find('td').text();
				  var strSplit = text.split(",");

				  $('td[class!=ignore]').each(function(){
                    strSplit2 = $(this).text().split(",")
				  	for (var i = 0; i < strSplit.length; i++) {
                        for (var j=0; j < strSplit2.length; j++) {
                            if(strSplit2[j] === strSplit[i]) {
                                $(this).addClass('highlight_tr');
                            }
                        }
                    }
				  });

				  },function(){
				  $(this).parent().removeClass('highlight_tr');

				  var text = $(this).parent().find('td').text();
				  var strSplit = text.split(",");

				  $('td').each(function(){
                    strSplit2 = $(this).text().split(",")
				  	for (var i = 0; i < strSplit.length; i++) {
                        for (var j=0; j < strSplit2.length; j++) {
                            if(strSplit2[j] === strSplit[i]) {
                                $(this).removeClass('highlight_tr');
                            }
                        }
				  	}
				  });
				}
				);
			}
	
			// $(function() {
			// 	drawStuff(query);
			// });

			function formSubmit() {
				var text = $("#input").val();
				console.log(text);
				var response = $.ajax({
					type: 'GET',
					url: "http://localhost/post?sql=".concat(text.replace(/\n/g, " "))
				}).done(function (uniqData) {
					console.log(JSON.stringify(uniqData));
					drawStuff(uniqData);
				});
			}

				// $('.node td').hide();
				$('th').click(function() {
			       $(this).parents('table').find('td').toggle();
			    }); 
			    $('#expandall').click(function(){
			    	$('td').toggle();
			    });

		</script>
		<style type="text/css" media="screen">
			* {
				margin: 0em;
				padding: 0em;
			}
			body {
				font-family: Helvetica, Arial, sans-serif;
			}
			#top {
				margin: 5em 5em 0em;
			}
			#logo {
				width: 130px;
				height: 88px;
			}
			#head {
				margin: 0px auto;
				width: 500px;
			}
			h1 {
				display: inline-block;
				position: relative;
				top: 0.1em;
				margin-bottom: 2em;
			}
			#submit {
				outline: none;
			}
			textarea {
				width: 90%;
				height: 7em;
				vertical-align: top;
				font-family: Consolas, monospace;
			}
			div.node {
				position: absolute;
			}
			path.link {
				fill: none;
				stroke: #ccc;
				stroke-width: 2px;
			}
			.symbol {
				line-height: 1em;
				font-size: 2em;
				margin: -0.6em 0em 0em -0.5em;
				padding: 2px;
				background-color: white;
				display: block;
				font-family: Georgia, serif;
			}
			#container {
				position: relative;
				width: 80%;
				height: 100%;
				margin: 0em auto;
			}
			table {
				border: 1px solid #ccc;
				font-size: 0.8em;
				border-collapse: collapse;
				margin: -1em 0em 0em -50%;
				display: block;
				min-width: 8em;
			}
			th, td {
				padding-left: 10px;
				padding-right: 10px;
				padding: 3px;
				border: 1px solid #ccc;
				background-color: #fff;
				text-align: center;
			}
			td, .identifier {
				font-family: Consolas, monospace;
			}
			td.operator {
				font-weight: bold;
			}
			th {
				background-color: #48c;
				color: #fff;
				font-size: 1.2em;
				padding-bottom: 2px;
			}
			tr:first-child th {
				border: 1px solid #666;
			}
			th.transient {
				background-color: #4c8;
				font-weight: bold;
				text-transform: none;
				font-style: none;
			}
			th.extra {
				background-color: #ccc;
			}
			.highlight_tr {
				background-color: yellow;
			}
		</style>
	</head>
	<body>
		<div id="top">
			<div id="head"><img src="logo.png" id="logo"><h1>SQL Goggles</h1></div>
			<textarea id="input" rows="8" cols="40">
SELECT user.first_name, user.last_name, country.name
FROM user
JOIN country ON country_code = code
WHERE country.name IN ('Kazakhstan', 'Burundi')</textarea>
			<input type="button" onClick="formSubmit()" id="submit" value="Go!" class="btn btn-primary btn-large">
			<input type="button" id="expandall" value="Minimize All" class="btn btn-primary btn-large">
		</div>
		</div>
		<div id="container"></div>
	</body>
</html>
